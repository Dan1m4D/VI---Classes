<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
    </style>

    <script type="text/javascript">
        function draw(geo_data) {
            // código de visualização
            var margin = 75,
                width = 1400 - margin,
                height = 600 - margin;

            var svg = d3.select("body")
                .append("svg")
                .attr("width", width + margin)
                .attr("height", height + margin)
                .append('g')
                .attr('class', 'map');

            var projection = d3.geoMercator()
                .scale(170)
                .translate([width / 2, height / 2]);

            var path = d3.geoPath().projection(projection);

            svg.append("path")
                .attr("d", path(geo_data))
                .attr("fill", "rgb(190,100,70)")
                .attr("stroke", "black")
                .attr("stroke-width", 1);

            function plot_circles(data) {
                //console.table(data[0]);
                //console.log(data[0].date);
                var nested = d3.nest()
                    .key(function (d) {
                        //console.log( d["date"].getUTCFullYear());
                        //debugger;
                        return d["date"].getUTCFullYear();
                    })
                    .rollup(function (leaves) {
                        //console.table(leaves[0]);
                        //debugger;
                        var total = d3.sum(leaves, function (d) {
                            return d["attendance"];
                        });

                        var coords = leaves.map(function (d) {
                            return projection([+d.long, +d.lat]);
                        });

                        var centerx = d3.mean(coords, function (d) { return d[0]; });
                        var centery = d3.mean(coords, function (d) { return d[1]; });

                        return {
                            "attendance": +total,
                            "x": centerx,
                            "y": centery
                        };
                    })
                    .entries(data);

                //console.table(nested);
                //debugger

                var attendance_extent = d3.extent(nested,function(d){
                    return d.value["attendance"];
                })

                //var radius_scale=d3.scaleLinear().domain(attendance_extent).range([0,15]);
                var radius_scale=d3.scaleSqrt().domain(attendance_extent).range([0,15]);

                svg.append('g')
                    .attr("class", "attendance")
                    .selectAll("circle")
                    .data(nested)
                    .enter()
                    .append("circle")
                    .attr("cx", function (d) { return d.value["x"] })
                    .attr("cy", function (d) { return d.value["y"] })
                    //.attr("r", 5);
                    .attr("r", function(d) { console.log(radius_scale(d.value["attendance"])); return radius_scale(d.value["attendance"]) })
                    .attr("fill","rbg(247,148,32)")
                    .attr("stroke","black")
                    .attr("stroke-width", 1)
                    .attr("opacity", 0.7);
            }

            var parseTime = d3.timeParse("%d-%m-%Y (%H:%M h)");

                d3.tsv("world_cup_geo.tsv", function (d) {
                    d["attendance"] = +d["attendance"];
                    d["date"] = parseTime(d["date"]);
                    return (d)
                }, plot_circles);

            };
    </script>
</head>

<body>
    <script type="text/javascript">
            // Leitura do ficheiro GeoJSON
            d3.json("world_countries.json", draw);
    </script>
</body>

</html>