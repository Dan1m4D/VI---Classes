<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
    </style>

    <script type="text/javascript">
        function draw(geo_data) {
            // código de visualização
            var margin = 75,
                width = 1400 - margin,
                height = 600 - margin;

            var svg = d3.select("body")
                .append("svg")
                .attr("width", width + margin)
                .attr("height", height + margin)
                .append('g')
                .attr('class', 'map');

            // v4   
            var projection = d3.geoMercator()
                .scale(150)
                .translate([width / 2, height / 2]);

            var path = d3.geoPath().projection(projection);

            svg.append("path")
                .attr("d", path(geo_data))
                .attr("fill", "rgb(9,165,170")
                .attr("stroke", "black")
                .attr("stroke-width", 0.5);

            function plot_circles(data) {
                var nested = d3.nest()
                    .key(function (d) {
                        return d["date"].getUTCFullYear();
                    })
                    .rollup(function (leaves) {
                        var total = d3.sum(leaves, function (d) {
                            return d["attendance"];
                        });

                        var coords = leaves.map(function (d) {
                            return projection([+d.long, +d.lat]);
                        });

                        var centerx = d3.mean(coords, function (d) { return d[0]; });
                        var centery = d3.mean(coords, function (d) { return d[1]; });

                        return {
                            "attendance": +total,
                            "x": centerx,
                            "y": centery
                        };
                    })
                    .entries(data);

                console.table(nested);

                var attendance_extent = d3.extent(nested, function (d) {
                    return d.value["attendance"];
                })

                console.log(attendance_extent);

                var radius_scale = d3.scaleSqrt().domain(attendance_extent).range([0, 15]);

                svg.append('g')
                    .attr("class", "attendance")
                    .selectAll("circle")
                    .data(nested)
                    .enter()
                    .append("circle")
                    .attr("cx", function (d) {return d.value["x"];  })
                    .attr("cy", function (d) {return d.value["y"]; })
                    //.attr("r", 5);
                    //.attr("r", function(d) { console.log(radius_scale(d.value["attendance"])); return radius_scale(d.value["attendance"]) });
                    .attr("r", function (d) { console.log(radius_scale(d.value["attendance"])); return radius_scale(d.value["attendance"]) })
                    .on("mouseover", handleMouseOver)
                    .on("mouseout", handleMouseOut);

                //console.log("100");
                //console.log(radius_scale(100));
                //debugger;

                // Create Event Handlers for mouse
                function handleMouseOver(d, i) {  // Add interactivity

                    // Use D3 to select element, change color and size
                    console.log("ole");

                    d3.select(this).attr("fill","red");
                    /*    fill: "orange"//,
                        //r: radius * 2
                    });*/
                    
                    //   Specify where to put label of text
                    svg.append("text").attr("id", function() {return "t"+d.key;})
                        .attr("x", function() { return d.value["x"] ; })
                        .attr("y", function() { return d.value["y"] + 20; })
                        .attr("text-anchor","middle")
                        .attr("fill","red")
                        .attr("size",20)
                        .text(function() {return d.key});

                    /*svg.append("text").attr({
                        id: "t" + d.key,  // Create an id for text so we can select it later for removing on mouseout
                        x: function () { return d.value["x"] - 30; },
                        y: function () { return d.value["y"] - 15; }
                    })
                        .text(function () {
                            return d.key;  // Value of the text
                        });*/
                }

                function handleMouseOut(d, i) {
                    // Use D3 to select element, change color back to normal
                    d3.select(this).attr("fill","black");
                    /*d3.select(this).attr({
                        fill: "black",
                        //r: radius
                    });*/

                    // Select text by id and then remove
                    d3.select("#t" + d.key).remove();  // Remove text location
                }



            }

            var parseTime = d3.timeParse("%d-%m-%Y (%H:%M h)");

            console.log("ola mundo");
            d3.tsv("world_cup_geo.tsv", function (data) {
                //d3.csv("world_cup.csv", function(data) {
                //console.log(data);
                //console.log(data["date"]);


                //console.log("ole1");
                data["attendance"] = +data["attendance"];
                data["date"] = parseTime(data["date"]);

                return data;

                //console.log("ole2");
                //console.log(data["date"]);

                /*console.log(data);*/
            }, plot_circles);



            /*function plot_circles(data) {
                debugger;
                console.table(data);
                /*var nested = d3.nest()
                    .key(function (d) {
                        return d['date'].getUTCFullYear();
                    })
                    .rollup(function (leaves) {
                        var total = d3.sum(leaves, function (d) {
                            return d['attendance'];
                        });

                        var coords = leaves.map(function (d) {
                            return projection([+d.long, +d.lat]);
                        });

                        var centerx = d3.mean(coords, function (d) { return d[0]; });
                        var centery = d3.mean(coords, function (d) { return d[1]; });

                        return {
                            'attendance': total,
                            'x': centerx,
                            'y': centery
                        };
                    })
                    .entries(data);
                    debugger;


                svg.append('g')
                    .attr("class", "attendance")
                    .selectAll("circle")
                    .data(nested)
                    .enter()
                    .append("circle")
                    .attr("cx", function (d) { return d.values['x'] })
                    .attr("cy", function (d) { return d.values['y'] })
                    .attr("r", 5);*/


            /*}

            var formatTime = d3.timeFormat("%d-%m-%Y (%H:%M h)");
            /*t = new Date(2014, 4, 1);
            console.log(formatTime(t));*/

            /*d3.tsv("world_cup_geo.tsv", function (error, d) {
                if (error) throw error;
                
                d['attendance'] = +d['attendance']; // Força string a valores
                d['date'] = formatTime(d['date']);
                //d['date'] = d['date'];
                
                /*data.forEach(function(d) {
                    d['attendance'] = +d['attendance']; // Força string a valores
                    d['date'] = formatTime(d['date']);
                });*/

            //}, plot_circles);
        };
    </script>
</head>

<body>
    <script type="text/javascript">
        // Leitura do ficheiro GeoJSON
        d3.json("world_countries.json", draw);
    </script>
</body>

</html>